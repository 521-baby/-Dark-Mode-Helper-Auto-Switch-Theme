// ==UserScript==
// @name              âœ¨å¤œé—´æ¨¡å¼åŠ©æ‰‹
// @namespace
// @version           1.0.0
// @description       âœ¨ å®šæ—¶è‡ªåŠ¨åˆ‡æ¢å¤œé—´æ¨¡å¼ | 4ç§ä¸»é¢˜åˆ‡æ¢ï¼ˆå¤œé—´1ï¼Œæš—è‰²2ï¼ŒæŠ¤çœ¼3ï¼Œç™½å¤©4ï¼‰|è‡ªå®šä¹‰å½“å‰æ¨¡å¼|è‡ªå®šä¹‰æ˜¼å¤œæ—¶é—´| ç½‘ç«™ç™½åå• | æŠ¤çœ¼æ¨¡å¼ ğŸ›¡ï¸ğŸ‘ï¸
// @author            ä¼é»‘ç”šè€Œ
// @license           MIT

// @match             *://*/*
// @require           https://unpkg.com/darkrule@1.0.4/dist/rule.min.js
// @require           https://unpkg.com/sweetalert2@10.16.6/dist/sweetalert2.min.js
// @resource          swalStyle https://unpkg.com/sweetalert2@10.16.6/dist/sweetalert2.min.css
// @run-at            document-start
// @grant             GM_getValue
// @grant             GM_setValue
// @grant             GM_registerMenuCommand
// @grant             GM_getResourceText
// @icon              
// ==/UserScript==

;(function () {
    'use strict';

    let util = {
        getValue(name) {
            return GM_getValue(name);
        },

        setValue(name, value) {
            GM_setValue(name, value);
        },

        addStyle(id, tag, css) {
            tag = tag || 'style';
            let doc = document, styleDom = doc.getElementById(id);
            if (styleDom) return;
            let style = doc.createElement(tag);
            style.rel = 'stylesheet';
            style.id = id;
            tag === 'style' ? style.innerHTML = css : style.href = css;
            doc.head.appendChild(style);
        },

        hover(ele, fn1, fn2) {
            ele.onmouseenter = function () {  //ç§»å…¥äº‹ä»¶
                fn1.call(ele);
            };
            ele.onmouseleave = function () { //ç§»å‡ºäº‹ä»¶
                fn2.call(ele);
            };
        },

        addThemeColor(color) {
            let doc = document, meta = doc.getElementsByName('theme-color')[0];
            if (meta) return meta.setAttribute('content', color);
            let metaEle = doc.createElement('meta');
            metaEle.name = 'theme-color';
            metaEle.content = color;
            doc.head.appendChild(metaEle);
        },

        getThemeColor() {
            let meta = document.getElementsByName('theme-color')[0];
            if (meta) {
                return meta.content;
            }
            return '#ffffff';
        },

        removeElementById(eleId) {
            let ele = document.getElementById(eleId);
            ele && ele.parentNode.removeChild(ele);
        },

        hasElementById(eleId) {
            return document.getElementById(eleId);
        },

        filter: '-webkit-filter: url(#dark-mode-filter) !important; filter: url(#dark-mode-filter) !important;',
        reverseFilter: '-webkit-filter: url(#dark-mode-reverse-filter) !important; filter: url(#dark-mode-reverse-filter) !important;',
        firefoxFilter: `filter: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="dark-mode-filter" color-interpolation-filters="sRGB"><feColorMatrix type="matrix" values="0.283 -0.567 -0.567 0 0.925 -0.567 0.283 -0.567 0 0.925 -0.567 -0.567 0.283 0 0.925 0 0 0 1 0"/></filter></svg>#dark-mode-filter') !important;`,
        firefoxReverseFilter: `filter: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="dark-mode-reverse-filter" color-interpolation-filters="sRGB"><feColorMatrix type="matrix" values="0.333 -0.667 -0.667 0 1 -0.667 0.333 -0.667 0 1 -0.667 -0.667 0.333 0 1 0 0 0 1 0"/></filter></svg>#dark-mode-reverse-filter') !important;`,
        noneFilter: '-webkit-filter: none !important; filter: none !important;',
    };
// ===== æ¨¡å¼æ•°æ®ç»“æ„ä¸åˆ‡æ¢é€»è¾‘ =====
const MODES = [
    { key: 'night', name: 'å¤œé—´', icon: 'moon', id: 1 },
    { key: 'dark', name: 'æš—è‰²', icon: 'eye', id: 2 },
    { key: 'eye', name: 'æŠ¤çœ¼', icon: 'palette', id: 3 },
    { key: 'light', name: 'ç™½å¤©', icon: 'sun', id: 4 }
];
function getEnabledModes() {
    const enableEye = util.getValue('bright_dark_mode');
    const enableDark = util.getValue('menu_forcedToEnable'); // ä»è®¾ç½®ä¸­è·å–æš—è‰²æ¨¡å¼å¼€å…³
    let modes = [MODES[0]]; // å¤œé—´
    if (enableEye) modes.push(MODES[1]);
    if (enableDark) modes.push(MODES[2]);
    modes.push(MODES[3]); // ç™½å¤©
    return modes;
}
function getCurrentModeIndex() {
    const modes = getEnabledModes();
    let current = util.getValue('menu_darkModeType') || 1;

    // è‡ªåŠ¨åˆ‡æ¢æ¨¡å¼
    const autoSwitch = util.getValue('menu_autoSwitch');
    if (autoSwitch && autoSwitch.includes('|')) {
        const [dayMode, nightMode] = autoSwitch.split('|').map(Number);
        const [dayStart, nightStart] = (util.getValue('menu_customTime') || '6:00|18:00').split('|');
        // è§£ææ—¶é—´
        function parseTime(str) {
            const [h, m] = str.split(':').map(Number);
            return h * 60 + (m || 0);
        }
        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes();
        const dayStartMinutes = parseTime(dayStart);
        const nightStartMinutes = parseTime(nightStart);

        let isDay;
        if (dayStartMinutes < nightStartMinutes) {
            isDay = nowMinutes >= dayStartMinutes && nowMinutes < nightStartMinutes;
        } else {
            // ä¾‹å¦‚ 18:00|6:00 è¿™ç§è·¨å¤©
            isDay = nowMinutes >= dayStartMinutes || nowMinutes < nightStartMinutes;
        }
        current = isDay ? dayMode : nightMode;
    }

    let idx = modes.findIndex(m => m.id == current);
    if (idx === -1) idx = 0;
    return idx;
}
function setCurrentModeByIndex(idx) {
    const modes = getEnabledModes();
    util.setValue('menu_darkModeType', modes[idx].id);
}
    let main = {
        /**
         * é…ç½®é»˜è®¤å€¼
         */
        initValue() {
            let value = [{
                name: 'dark_mode',
                value: 'light'
            }, {
                name: 'button_position',
                value: 'left'
            }, {
                name: 'button_size',
                value: 32
            }, {
                name: 'exclude_list',
                value: ['youku.com', 'v.youku.com', 'www.douyu.com', 'www.iqiyi.com', 'vip.iqiyi.com', 'mail.qq.com', 'live.kuaishou.com']
            }, {
                name: 'origin_theme_color',
                value: '#ffffff'
            }, {
                name: 'menu_autoRecognition',
                value: true
            }, {
                name: 'menu_forcedToEnable',
                value: false
            }, {
                name: 'menu_darkModeType',
                value: 2
            }, {
                name: 'menu_customTime',
                value: '6:00|18:00'
            }, {
                name: 'menu_autoSwitch',
                value: ''
            }, {
                name: 'button_hidden',
                value: false
            }, {
                name: 'bright_dark_mode',
                value: true
            }];

            value.forEach((v) => {
                util.getValue(v.name) === undefined && util.setValue(v.name, v.value);
            });
        },

        addExtraStyle() {
            try {
                return darkModeRule;
            } catch (e) {
                return '';
            }
        },

        createDarkFilter() {
            if (util.hasElementById('dark-mode-svg')) return;
            let svgDom = '<svg id="dark-mode-svg" style="height: 0; width: 0;"><filter id="dark-mode-filter" x="0" y="0" width="99999" height="99999"><feColorMatrix type="matrix" values="0.283 -0.567 -0.567 0 0.925 -0.567 0.283 -0.567 0 0.925 -0.567 -0.567 0.283 0 0.925 0 0 0 1 0"></feColorMatrix></filter><filter id="dark-mode-reverse-filter" x="0" y="0" width="99999" height="99999"><feColorMatrix type="matrix" values="0.333 -0.667 -0.667 0 1 -0.667 0.333 -0.667 0 1 -0.667 -0.667 0.333 0 1 0 0 0 1 0"></feColorMatrix></filter></svg>';
            let div = document.createElementNS('http://www.w3.org/1999/xhtml', 'div');
            div.innerHTML = svgDom;
            let frag = document.createDocumentFragment();
            while (div.firstChild)
                frag.appendChild(div.firstChild);
            document.head.appendChild(frag);
        },

        createDarkStyle() {
            util.addStyle('dark-mode-style', 'style', `
                @media screen {
                    html {
                        ${this.isFirefox() ? util.firefoxFilter : util.filter}
                        scrollbar-color: #454a4d #202324;
                    }

                    /* Default Reverse rule */
                    img,
                    video,
                    iframe,
                    canvas,
                    :not(object):not(body) > embed,
                    object,
                    svg image,
                    [style*="background:url"],
                    [style*="background-image:url"],
                    [style*="background: url"],
                    [style*="background-image: url"],
                    [background],
                    twitterwidget,
                    .sr-reader,
                    .no-dark-mode,
                    .sr-backdrop {
                        ${this.isFirefox() ? util.firefoxReverseFilter : util.reverseFilter}
                    }

                    [style*="background:url"] *,
                    [style*="background-image:url"] *,
                    [style*="background: url"] *,
                    [style*="background-image: url"] *,
                    input,
                    [background] *,
                    img[src^="https://s0.wp.com/latex.php"],
                    twitterwidget .NaturalImage-image {
                        ${util.noneFilter}
                    }

                    /* Text contrast */
                    html {
                        text-shadow: 0 0 0 !important;
                    }

                    /* Full screen */
                    .no-filter,
                    :-webkit-full-screen,
                    :-webkit-full-screen *,
                    :-moz-full-screen,
                    :-moz-full-screen *,
                    :fullscreen,
                    :fullscreen * {
                        ${util.noneFilter}
                    }

                    ::-webkit-scrollbar {
                        background-color: #202324;
                        color: #aba499;
                    }
                    ::-webkit-scrollbar-thumb {
                        background-color: #454a4d;
                    }
                    ::-webkit-scrollbar-thumb:hover {
                        background-color: #575e62;
                    }
                    ::-webkit-scrollbar-thumb:active {
                        background-color: #484e51;
                    }
                    ::-webkit-scrollbar-corner {
                        background-color: #181a1b;
                    }

                    /* Page background */
                    html {
                        background: #fff !important;
                    }

                    ${this.addExtraStyle()}
                }

                @media print {
                    .no-print {
                        display: none !important;
                    }
                }`);
        },

        setThemeColor() {
            util.setValue('origin_theme_color', util.getThemeColor());
        },

        enableDarkMode() {
            if (this.isFullScreen()) return;
            !this.isFirefox() && this.createDarkFilter();
            this.createDarkStyle();
            util.addThemeColor('#131313');
        },

        disableDarkMode() {
            util.removeElementById('dark-mode-svg');
            util.removeElementById('dark-mode-style');
            util.addThemeColor(util.getValue('origin_theme_color'));
        },
        // æ–°å¢ï¼šæ ¹æ®å½“å‰æ¨¡å¼åŠ¨æ€åˆ‡æ¢æ ·å¼
applyCurrentModeStyle() {
    const modes = getEnabledModes();
    const idx = getCurrentModeIndex();
    const mode = modes[idx];
    // æ¸…ç†æ‰€æœ‰æ ·å¼
    util.removeElementById('dark-mode-style');
    util.removeElementById('dark-mode-svg');
    // å¤œé—´
    if (mode.key === 'night') {
        this.enableDarkMode();
    } else if (mode.key === 'light') {
    // ç™½å¤©æ¨¡å¼ = äº®åº¦æ»¤é•œ
    let style_40 = (util.getValue('menu_customMode4') || '100|100').split('|');
    let isDay = (new Date().getHours() >= 6 && new Date().getHours() < 18);
    let brightness = isDay ? style_40[0] : style_40[1];
    util.addStyle('dark-mode-style', 'style', `html { filter: brightness(${brightness}% ) !important; background: #fff !important; }`);
    util.addThemeColor('#ffffff');
}else if (mode.key === 'dark') {
        // æŠ¤çœ¼æ¨¡å¼ = äº®åº¦æ»¤é•œ
        let style_10 = (util.getValue('menu_customMode1') || '60|50').split('|');
        let isDay = (new Date().getHours() >= 6 && new Date().getHours() < 18);
        let brightness = isDay ? style_10[0] : style_10[1];
        util.addStyle('dark-mode-style', 'style', `html { filter: brightness(${brightness}% ) !important; background: #fff !important; }`);
        util.addThemeColor('#e6f7e6');
    } else if (mode.key === 'eye') {
        // æš—è‰²æ¨¡å¼ = äº®åº¦+æš–è‰²æ»¤é•œ
        let style_20 = (util.getValue('menu_customMode2') || '60|40|50|50').split('|');
        let isDay = (new Date().getHours() >= 6 && new Date().getHours() < 18);
        let brightness = isDay ? style_20[0] : style_20[2];
        let sepia = isDay ? style_20[1] : style_20[3];
        util.addStyle('dark-mode-style', 'style', `html { filter: brightness(${brightness}% ) sepia(${sepia}% ) !important; background: #fff !important; }`);
        util.addThemeColor('#f5e6d6');
    }
},

        addButton() {
    if (this.isTopWindow() && !util.getValue('button_hidden')) {
        let buttonSize = util.getValue('button_size');
        let buttonPosition = util.getValue('button_position');
        let svgSize = parseInt(buttonSize * 0.6);
        let buttonWidth = +buttonSize + 2;

        // SVG å›¾æ ‡å®šä¹‰
        const icons = {
            moon: `<svg fill="#009fe8" id="svg-light" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <path d="M587.264 104.96c33.28 57.856 52.224 124.928 52.224 196.608 0 218.112-176.128 394.752-393.728 394.752-29.696 0-58.368-3.584-86.528-9.728C223.744 832.512 369.152 934.4 538.624 934.4c229.376 0 414.72-186.368 414.72-416.256 1.024-212.992-159.744-389.12-366.08-413.184z"></path> <path d="M340.48 567.808l-23.552-70.144-70.144-23.552 70.144-23.552 23.552-70.144 23.552 70.144 70.144 23.552-70.144 23.552-23.552 70.144zM168.96 361.472l-30.208-91.136-91.648-30.208 91.136-30.208 30.72-91.648 30.208 91.136 91.136 30.208-91.136 30.208-30.208 91.648z"></path> </svg>`,
            sun: `<svg fill="#009fe8" id="svg-dark" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <path d="M234.24 512a277.76 277.76 0 1 0 555.52 0 277.76 277.76 0 1 0-555.52 0zM512 187.733a42.667 42.667 0 0 1-42.667-42.666v-102.4a42.667 42.667 0 0 1 85.334 0v102.826A42.667 42.667 0 0 1 512 187.733zm-258.987 107.52a42.667 42.667 0 0 1-29.866-12.373l-72.96-73.387a42.667 42.667 0 0 1 59.306-59.306l73.387 72.96a42.667 42.667 0 0 1 0 59.733 42.667 42.667 0 0 1-29.867 12.373zm-107.52 259.414H42.667a42.667 42.667 0 0 1 0-85.334h102.826a42.667 42.667 0 0 1 0 85.334zm34.134 331.946a42.667 42.667 0 0 1-29.44-72.106l72.96-73.387a42.667 42.667 0 0 1 59.733 59.733l-73.387 73.387a42.667 42.667 0 0 1-29.866 12.373zM512 1024a42.667 42.667 0 0 1-42.667-42.667V878.507a42.667 42.667 0 0 1 85.334 0v102.826A42.667 42.667 0 0 1 512 1024zm332.373-137.387a42.667 42.667 0 0 1-29.866-12.373l-73.387-73.387a42.667 42.667 0 0 1 0-59.733 42.667 42.667 0 0 1 59.733 0l72.96 73.387a42.667 42.667 0 0 1-29.44 72.106zm136.96-331.946H878.507a42.667 42.667 0 1 1 0-85.334h102.826a42.667 42.667 0 0 1 0 85.334zM770.987 295.253a42.667 42.667 0 0 1-29.867-12.373 42.667 42.667 0 0 1 0-59.733l73.387-72.96a42.667 42.667 0 1 1 59.306 59.306l-72.96 73.387a42.667 42.667 0 0 1-29.866 12.373z"></path> </svg>`,
            eye: `<svg fill="#009fe8" id="svg-cloud" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
  <path d="M80 720a200 160 0 0 1 200-160h40a280 220 0 0 1 544-60 180 140 0 1 1 80 280H320A200 160 0 0 1 80 720z"/>
</svg>`,
            palette: `<svg fill="#009fe8" id="svg-eye" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 224c-256 0-416 224-416 288s160 288 416 288 416-224 416-288-160-288-416-288zm0 480a192 192 0 1 1 0-384 192 192 0 0 1 0 384zm0-320a128 128 0 1 0 0 256 128 128 0 0 0 0-256z"/></svg>`
        };
        const modes = getEnabledModes();
        const idx = getCurrentModeIndex();
        const mode = modes[idx];
        let html = `<div class="no-print" id="darkmode-container" style="position: fixed; ${buttonPosition}: -${buttonWidth / 2}px; bottom: 25px; cursor: pointer; z-index: 2147483647; user-select: none;">
            <div id="darkmode-button" style="width: ${buttonSize}px;height: ${buttonSize}px;background: #fff;border:1px solid #f6f6f6;display: flex;align-items: center;justify-content: center;border-radius: 50%;position: relative;">
                ${icons[mode.icon]}
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        let containerDOM = document.getElementById('darkmode-container');
        let buttonDOM = document.getElementById('darkmode-button');
        util.hover(containerDOM, () => {
            containerDOM.style[buttonPosition] = '0px';
            containerDOM.style.transition = `${buttonPosition} 0.3s`
        }, () => {
            containerDOM.style[buttonPosition] = `-${buttonWidth / 2}px`;
            containerDOM.style.transition = `${buttonPosition} 0.3s`
        });
        buttonDOM.addEventListener("click", () => {
    const modes = getEnabledModes();
    let idx = getCurrentModeIndex();
    idx = (idx + 1) % modes.length;
    setCurrentModeByIndex(idx);
    main.applyCurrentModeStyle();
    // é‡æ–°æ¸²æŸ“æŒ‰é’®
    document.getElementById('darkmode-container')?.remove();
    this.addButton();
});
    }
},

        registerMenuCommand() {
            if (this.isTopWindow()) {
                let whiteList = util.getValue('exclude_list');
                let host = location.host;
                if (whiteList.includes(host)) {
                    GM_registerMenuCommand('ğŸ’¡ å½“å‰ç½‘ç«™ï¼šâŒ', () => {
                        let index = whiteList.indexOf(host);
                        whiteList.splice(index, 1);
                        util.setValue('exclude_list', whiteList);
                        history.go(0);
                    });
                } else {
                    GM_registerMenuCommand('ğŸ’¡ å½“å‰ç½‘ç«™ï¼šâœ”ï¸', () => {
                        whiteList.push(host);
                        util.setValue('exclude_list', Array.from(new Set(whiteList)));
                        history.go(0);
                    });
                }

                GM_registerMenuCommand('âš™ï¸ è®¾ç½®', () => {
                    let style = `
                                .darkmode-popup { font-size: 14px !important; }
                                .darkmode-center { display: flex;align-items: center; }
                                .darkmode-setting-label { display: flex;align-items: center;justify-content: space-between;padding-top: 15px; }
                                .darkmode-setting-label-col { display: flex;align-items: flex-start;;padding-top: 15px;flex-direction:column }
                                .darkmode-setting-radio { width: 16px;height: 16px; }
                                .darkmode-setting-textarea { width: 100%; margin: 14px 0 0; height: 100px; resize: none; border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; color: #666; line-height: 1.2; }
                                .darkmode-setting-input { border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; width: 100px}
                            `;
                    util.addStyle('darkmode-style', 'style', style);
                    util.addStyle('swal-pub-style', 'style', GM_getResourceText('swalStyle'));
                    let excludeListStr = util.getValue('exclude_list').join('\n');

                    let dom = `<div style="font-size: 1em;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <img src="" style="width:141px; height:141px; display: block; margin: 0 auto;">
                            </div>
                            <p style="color: #666; text-align: center; margin: 10px 0 0; font-size: 0.9em;">
                                ç”Ÿæ´»ä¸æ˜“ï¼ŒçŒªçŒªå¹æ°” â€”â€” èµå£é¥²æ–™ï¼Œè®©æˆ‘å°‘æ°”ï¼ğŸ·âœ¨
                            </p>
                            <label class="darkmode-setting-label">æŒ‰é’®ä½ç½® <div id="S-Dark-Position" class="darkmode-center"><input type="radio" name="buttonPosition" ${util.getValue('button_position') === 'left' ? 'checked' : ''} class="darkmode-setting-radio" value="left">å·¦ <input type="radio" name="buttonPosition" style="margin-left: 30px;" ${util.getValue('button_position') === 'right' ? 'checked' : ''} class="darkmode-setting-radio" value="right">å³</div></label>
                              <label class="darkmode-setting-label"><span style="text-align: left;">æŒ‰é’®å¤§å°ï¼ˆé»˜è®¤ï¼š30ï¼‰<small id="currentSize">å½“å‰ï¼š${util.getValue('button_size')}</small></span>
                              <input id="S-Dark-Size" type="range" class="darkmode-setting-range" min="20" max="50" step="2" value="${util.getValue('button_size')}">
                              </label>
                              <label class="darkmode-setting-label-col">æ’é™¤ä¸‹åˆ—ç½‘å€ <textarea placeholder="åˆ—è¡¨ä¸­çš„åŸŸåå°†ä¸å¼€å¯å¤œé—´æ¨¡å¼ï¼Œä¸€è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ï¼šv.youku.com" id="S-Dark-Exclude" class="darkmode-setting-textarea">${excludeListStr}</textarea></label>
                              <label class="darkmode-setting-label">æ™ºèƒ½æ’é™¤è‡ªå¸¦æš—é»‘æ¨¡å¼çš„ç½‘é¡µ (beta) <input type="checkbox" ${util.getValue('menu_autoRecognition') ? 'checked' : ''} id="S-Dark-AutoRecognition"></label>
                              <label class="darkmode-setting-label">å¼€å¯æš—è‰²é€‰é¡¹ <input type="checkbox" ${util.getValue('bright_dark_mode') ? 'checked' : ''} id="S-Dark-BrightDarkMode"></label>
                              <label class="darkmode-setting-label">å¼€å¯æŠ¤çœ¼é€‰é¡¹ <input type="checkbox" ${util.getValue('menu_forcedToEnable') ? 'checked' : ''} id="S-Dark-ForcedToEnable"></label>
                              <label class="darkmode-setting-label">æŒ‰é’®éšè— <input type="checkbox" ${util.getValue('button_hidden') ? 'checked' : ''} id="S-Dark-ButtonHidden"></label>
                            </div>`;
                    Swal.fire({
                        title: 'å¤œé—´æ¨¡å¼é…ç½®',
                        html: dom,
                        icon: 'none',
                        showCloseButton: true,
                        confirmButtonText: 'ä¿å­˜',
                        customClass: {
                            popup: 'darkmode-popup'
                        },
                        width: '480px',
                    }).then((res) => {
                        res.isConfirmed && history.go(0);
                    });

                    document.getElementById('S-Dark-Position').addEventListener('click', (e) => {
                        e.target.tagName === "INPUT" && util.setValue('button_position', e.target.value);
                    });
                    document.getElementById('S-Dark-Size').addEventListener('change', (e) => {
                        util.setValue('button_size', e.currentTarget.value);
                        document.getElementById('currentSize').innerText = 'å½“å‰ï¼š' + e.currentTarget.value;
                    });
                    document.getElementById('S-Dark-Exclude').addEventListener('change', (e) => {
                        util.setValue('exclude_list', Array.from(new Set(e.currentTarget.value.split('\n').filter(Boolean))));
                    });
                    document.getElementById('S-Dark-AutoRecognition').addEventListener('change', (e) => {
                        util.setValue('menu_autoRecognition', e.currentTarget.checked);
                    });
                    document.getElementById('S-Dark-ForcedToEnable').addEventListener('change', (e) => {
                        util.setValue('menu_forcedToEnable', e.currentTarget.checked);
                    });
                    document.getElementById('S-Dark-BrightDarkMode').addEventListener('change', (e) => {
                        util.setValue('bright_dark_mode', e.currentTarget.checked);
                    });
                    document.getElementById('S-Dark-ButtonHidden').addEventListener('change', (e) => {
                        util.setValue('button_hidden', e.currentTarget.checked);
                    });
                });

                // åŠ¨æ€èœå•é¡¹ï¼Œæ˜¾ç¤ºå½“å‰æ¨¡å¼ç¼–å·å’Œåç§°
const modes = getEnabledModes();
const idx = getCurrentModeIndex();
const mode = modes[idx];
GM_registerMenuCommand(`${mode.id}ï¸âƒ£${mode.name} åˆ‡æ¢æ¨¡å¼`, () => {
    let idx = getCurrentModeIndex();
    idx = (idx + 1) % modes.length;
    setCurrentModeByIndex(idx);
    main.applyCurrentModeStyle();
    document.getElementById('darkmode-container')?.remove();
    main.addButton();
    location.reload();
});

                GM_registerMenuCommand('âš™ï¸ è‡ªå®šä¹‰å½“å‰æ¨¡å¼', () => {
    const currentMode = util.getValue('menu_darkModeType');
    let tip, defaults, name;
    switch (currentMode) {
        case 1:
            tip = 'è‡ªå®šä¹‰ [å¤œé—´æ¨¡å¼]ï¼Œä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ (éƒ¨åˆ†ç½‘é¡µå¯èƒ½éœ€è¦åˆ·æ–°)~\næ ¼å¼ï¼šäº®åº¦ (ç™½å¤©)|äº®åº¦ (æ™šä¸Š)\né»˜è®¤ï¼š60|50ï¼ˆå‡ä¸ºç™¾åˆ†æ¯” 1~100ï¼Œä¸éœ€è¦ % ç¬¦å·ï¼‰';
            defaults = '60|50';
            name = 'menu_customMode1';
            break;
        case 2:
            tip = 'è‡ªå®šä¹‰ [æš—è‰²æ¨¡å¼]ï¼Œä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ (éƒ¨åˆ†ç½‘é¡µå¯èƒ½éœ€è¦åˆ·æ–°)~\næ ¼å¼ï¼šäº®åº¦ (ç™½å¤©)|æš–è‰² (ç™½å¤©)|äº®åº¦ (æ™šä¸Š)|æš–è‰² (æ™šä¸Š)\né»˜è®¤ï¼š60|40|50|50ï¼ˆå‡ä¸ºç™¾åˆ†æ¯” 1~100ï¼Œä¸éœ€è¦ % ç¬¦å·ï¼‰';
            defaults = '60|40|50|50';
            name = 'menu_customMode2';
            break;
        case 3:
            tip = 'è‡ªå®šä¹‰ [æŠ¤çœ¼æ¨¡å¼]ï¼Œä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ (éƒ¨åˆ†ç½‘é¡µå¯èƒ½éœ€è¦åˆ·æ–°)~\næ ¼å¼ï¼šåè‰²\né»˜è®¤ï¼š90ï¼ˆå‡ä¸ºç™¾åˆ†æ¯” 50~100ï¼Œä¸éœ€è¦ % ç¬¦å·ï¼‰';
            defaults = '90';
            name = 'menu_customMode3';
            break;
        case 4:
    tip = 'è‡ªå®šä¹‰ [ç™½å¤©æ¨¡å¼]ï¼Œä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ (éƒ¨åˆ†ç½‘é¡µå¯èƒ½éœ€è¦åˆ·æ–°)~\næ ¼å¼ï¼šäº®åº¦ (ç™½å¤©)|äº®åº¦ (æ™šä¸Š)\né»˜è®¤ï¼š100|100ï¼ˆå‡ä¸ºç™¾åˆ†æ¯” 1~100ï¼Œä¸éœ€è¦ % ç¬¦å·ï¼‰';
    defaults = '100|100';
    name = 'menu_customMode4';
    break;
    }
    let newMods = prompt(tip, util.getValue(name));
    if (newMods === '') {
        util.setValue(name, defaults);
    } else if (newMods != null) {
        util.setValue(name, newMods);
    }
    // æŠ¤çœ¼æ¨¡å¼æœ‰æ’é™¤ç›®æ ‡
    if (currentMode === 3) {
        tip = 'è‡ªå®šä¹‰ [æŠ¤çœ¼æ¨¡å¼] æ’é™¤ç›®æ ‡ï¼Œä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ (éƒ¨åˆ†ç½‘é¡µå¯èƒ½éœ€è¦åˆ·æ–°)~\næ ¼å¼ï¼šCSS é€‰æ‹©å™¨ (å¦‚æœä¸ä¼šå†™å¯ä»¥æ‰¾æˆ‘)\né»˜è®¤ï¼šimg, .img, video, [style*="background"][style*="url"], svg\n (ä½¿ç”¨è‹±æ–‡é€—å·é—´éš”ï¼Œæœ«å°¾ä¸è¦æœ‰é€—å·)';
        defaults = 'img, .img, video, [style*="background"][style*="url"], svg';
        name = 'menu_customMode3_exclude';
        newMods = prompt(tip, util.getValue(name));
        if (newMods === '') {
            util.setValue(name, defaults);
        } else if (newMods != null) {
            util.setValue(name, newMods);
        }
    }
    if (document.getElementById('dark-mode-style')) {
        util.removeElementById('dark-mode-style');
        main.applyCurrentModeStyle();
    }
});

                GM_registerMenuCommand('ğŸ•’ è‡ªå®šä¹‰æ˜¼å¤œæ—¶é—´', () => {
    let newMods = prompt('è‡ªå®šä¹‰è„šæœ¬å†…å’Œç™½å¤©/æ™šä¸Šç›¸å…³çš„æ—¶é—´ï¼Œä¿®æ”¹ååˆ·æ–°ç½‘é¡µç”Ÿæ•ˆ~\næ ¼å¼ï¼š6:00|18:30 (å³ 6:00 ~ 18:30 ä¹‹é—´æ˜¯ç™½å¤©æ—¶é—´)\nä¹Ÿæ”¯æŒåå‘è®¾ç½®ï¼š14:00|12:00 (å³ 12:00 ~ 14:00 ä¹‹é—´æ˜¯å¤œæ™šæ—¶é—´)', util.getValue('menu_customTime'));
    if (newMods === '') {
        util.setValue('menu_customTime', '6:00|18:00');
    } else if (newMods != null) {
        util.setValue('menu_customTime', newMods);
    }
    location.reload();
});

                GM_registerMenuCommand('ğŸŒ™ æ™šä¸Šè‡ªåŠ¨åˆ‡æ¢æ¨¡å¼', () => {
    let newAutoSwitch = prompt('ç™½å¤©ã€æ™šä¸Šä½¿ç”¨ä¸åŒæ¨¡å¼ï¼Œä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ~\næ ¼å¼ï¼šç™½å¤©æ¨¡å¼|æ™šä¸Šæ¨¡å¼\nä¾‹å¦‚ï¼š1|3ï¼ˆå³ç™½å¤©æ¨¡å¼ 1 æ™šä¸Šæ¨¡å¼ 3ï¼‰\né»˜è®¤ï¼šç•™ç©ºï¼ˆå³å…³é—­è¯¥åŠŸèƒ½ï¼‰', util.getValue('menu_autoSwitch'));
    if (newAutoSwitch === '') {
        util.setValue('menu_autoSwitch', '');
    } else if (newAutoSwitch != null) {
        if (newAutoSwitch.split('|').length == 2) {
            util.setValue('menu_autoSwitch', newAutoSwitch);
        } else {
            alert(`å¡«å…¥å†…å®¹æ ¼å¼é”™è¯¯...`);
        }
    }
    location.reload();
});
            }
        },

        isDarkMode() {
            return util.getValue('dark_mode') === 'dark';
        },

        isInExcludeList() {
            return util.getValue('exclude_list').includes(location.host);
        },

        isFullScreen() {
            return document.fullscreenElement;
        },

        isFirefox() {
            return /Firefox/i.test(navigator.userAgent);
        },

        isTopWindow() {
            return window.self === window.top;
        },

        addListener() {
            document.addEventListener("fullscreenchange", (e) => {
                if (this.isFullScreen()) {
                    //è¿›å…¥å…¨å±
                    this.disableDarkMode();
                } else {
                    //é€€å‡ºå…¨å±
                    this.isDarkMode() && this.enableDarkMode();
                }
            });
        },

        firstEnableDarkMode() {
            if (document.head) {
                this.isDarkMode() && this.enableDarkMode();
            }
            const headObserver = new MutationObserver(() => {
                this.isDarkMode() && this.enableDarkMode();
            });
            headObserver.observe(document.head, {childList: true, subtree: true});

            if (document.body) {
                this.addButton();
            } else {
                const bodyObserver = new MutationObserver(() => {
                    if (document.body) {
                        bodyObserver.disconnect();
                        this.addButton();
                    }
                });
                bodyObserver.observe(document, {childList: true, subtree: true});
            }
        },

        init() {
            this.initValue();
            this.setThemeColor();
            this.registerMenuCommand();
            if (this.isInExcludeList()) return;
            this.addListener();
            this.firstEnableDarkMode();
            this.applyCurrentModeStyle();
        }
    };
    main.init();
})();
